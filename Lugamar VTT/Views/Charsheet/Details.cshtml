@model LugamarVTT.Models.Character
@using System
@using System.Linq

@{
    ViewData["Title"] = Model?.Name ?? "Character Details";
}

@section Styles {
    <link rel="stylesheet" href="~/css/charsheet.css" />
}

@functions {
    int Mod(int score) => (int)Math.Floor((score - 10) / 2.0);
}

<h1 class="mt-4 mb-3">@Model?.Name</h1>
<a asp-action="Index" class="btn btn-secondary mb-3">&larr; Back to list</a>

<div class="charsheet">
    <aside>
        <div class="card h-100 shadow-sm">
            <div class="card-header">Ability Scores</div>
            <div class="card-body ability-scores">
                <div class="ability">
                    <span class="label">STR</span>
                    <span class="score">@Model?.Strength</span>
                    <span class="mod">@Mod(Model?.Strength ?? 0)</span>
                </div>
                <div class="ability">
                    <span class="label">DEX</span>
                    <span class="score">@Model?.Dexterity</span>
                    <span class="mod">@Mod(Model?.Dexterity ?? 0)</span>
                </div>
                <div class="ability">
                    <span class="label">CON</span>
                    <span class="score">@Model?.Constitution</span>
                    <span class="mod">@Mod(Model?.Constitution ?? 0)</span>
                </div>
                <div class="ability">
                    <span class="label">INT</span>
                    <span class="score">@Model?.Intelligence</span>
                    <span class="mod">@Mod(Model?.Intelligence ?? 0)</span>
                </div>
                <div class="ability">
                    <span class="label">WIS</span>
                    <span class="score">@Model?.Wisdom</span>
                    <span class="mod">@Mod(Model?.Wisdom ?? 0)</span>
                </div>
                <div class="ability">
                    <span class="label">CHA</span>
                    <span class="score">@Model?.Charisma</span>
                    <span class="mod">@Mod(Model?.Charisma ?? 0)</span>
                </div>
            </div>
        </div>
    </aside>

    <div class="main">
        <div class="section card shadow-sm basic-info">
            <div class="card-header">Character Information</div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Race</dt>
                    <dd class="col-sm-9">@Model?.Race</dd>
                    <dt class="col-sm-3">Class</dt>
                    <dd class="col-sm-9">@Model?.Class</dd>
                    <dt class="col-sm-3">Alignment</dt>
                    <dd class="col-sm-9">@Model?.Alignment</dd>
                    <dt class="col-sm-3">Level</dt>
                    <dd class="col-sm-9">@Model?.Level</dd>
                </dl>
            </div>
        </div>

        <div class="section card shadow-sm hp">
            <div class="card-header">Hit Points</div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Current</dt>
                    <dd class="col-sm-8">@Model?.CurrentHitPoints</dd>
                    <dt class="col-sm-4">Total</dt>
                    <dd class="col-sm-8">@Model?.HitPoints</dd>
                </dl>
            </div>
        </div>

        <div class="section card shadow-sm saves">
            <div class="card-header">Saving Throws</div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Fortitude</dt>
                    <dd class="col-sm-8">@Model?.Fortitude</dd>
                    <dt class="col-sm-4">Reflex</dt>
                    <dd class="col-sm-8">@Model?.Reflex</dd>
                    <dt class="col-sm-4">Will</dt>
                    <dd class="col-sm-8">@Model?.Will</dd>
                </dl>
            </div>
        </div>

        <div class="section card shadow-sm speed-init">
            <div class="card-header">Speed &amp; Initiative</div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Speed</dt>
                    <dd class="col-sm-8">@Model?.Speed</dd>
                    <dt class="col-sm-4">Initiative</dt>
                    <dd class="col-sm-8">@Model?.Initiative</dd>
                </dl>
            </div>
        </div>

        <div class="section card shadow-sm armor-class">
            <div class="card-header">Armor Class</div>
            <div class="card-body">
                <table class="table table-sm table-striped sheet-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>DEX Modifier</th>
                            <th>Size Modifier</th>
                            <th>Armor Bonus</th>
                            <th>Shield Bonus</th>
                            <th>Natural Armor</th>
                            <th>Dodge</th>
                            <th>Misc</th>
                            <th>Deflection</th>
                            <th>Temp</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Armor Class</td>
                            <td>@Model?.ArmorClassBreakdown.DexModifier</td>
                            <td>@Model?.ArmorClassBreakdown.SizeModifier</td>
                            <td>@Model?.ArmorClassBreakdown.ArmorBonus</td>
                            <td>@Model?.ArmorClassBreakdown.ShieldBonus</td>
                            <td>@Model?.ArmorClassBreakdown.NaturalArmor</td>
                            <td>@Model?.ArmorClassBreakdown.Dodge</td>
                            <td>@Model?.ArmorClassBreakdown.Misc</td>
                            <td>@Model?.ArmorClassBreakdown.Deflection</td>
                            <td>@Model?.ArmorClassBreakdown.Temp</td>
                            <td>@Model?.ArmorClassBreakdown.Total</td>
                        </tr>
                        <tr>
                            <td>Touch</td>
                            <td>@Model?.TouchArmorClassBreakdown.DexModifier</td>
                            <td>@Model?.TouchArmorClassBreakdown.SizeModifier</td>
                            <td class="disabled-cell">@Model?.TouchArmorClassBreakdown.ArmorBonus</td>
                            <td class="disabled-cell">@Model?.TouchArmorClassBreakdown.ShieldBonus</td>
                            <td class="disabled-cell">@Model?.TouchArmorClassBreakdown.NaturalArmor</td>
                            <td>@Model?.TouchArmorClassBreakdown.Dodge</td>
                            <td>@Model?.TouchArmorClassBreakdown.Misc</td>
                            <td>@Model?.TouchArmorClassBreakdown.Deflection</td>
                            <td>@Model?.TouchArmorClassBreakdown.Temp</td>
                            <td>@Model?.TouchArmorClassBreakdown.Total</td>
                        </tr>
                        <tr>
                            <td>Flat-Footed</td>
                            <td class="disabled-cell">@Model?.FlatFootedArmorClassBreakdown.DexModifier</td>
                            <td>@Model?.FlatFootedArmorClassBreakdown.SizeModifier</td>
                            <td>@Model?.FlatFootedArmorClassBreakdown.ArmorBonus</td>
                            <td>@Model?.FlatFootedArmorClassBreakdown.ShieldBonus</td>
                            <td>@Model?.FlatFootedArmorClassBreakdown.NaturalArmor</td>
                            <td class="disabled-cell">@Model?.FlatFootedArmorClassBreakdown.Dodge</td>
                            <td>@Model?.FlatFootedArmorClassBreakdown.Misc</td>
                            <td>@Model?.FlatFootedArmorClassBreakdown.Deflection</td>
                            <td>@Model?.FlatFootedArmorClassBreakdown.Temp</td>
                            <td>@Model?.FlatFootedArmorClassBreakdown.Total</td>
                        </tr>
                    </tbody>
                </table>
                <table class="table table-sm table-striped sheet-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Base Attack Bonus</th>
                            <th>STR Bonus</th>
                            <th>DEX Bonus</th>
                            <th>Size Bonus</th>
                            <th>Misc</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>CMD</td>
                            <td>@Model?.CombatManeuverDefense.BaseAttackBonus</td>
                            <td>@Model?.CombatManeuverDefense.StrBonus</td>
                            <td>@Model?.CombatManeuverDefense.DexBonus</td>
                            <td>@Model?.CombatManeuverDefense.SizeBonus</td>
                            <td>@Model?.CombatManeuverDefense.Misc</td>
                            <td>@Model?.CombatManeuverDefense.Total</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section card shadow-sm attack-bonus">
            <div class="card-header">Attack Bonus</div>
            <div class="card-body">
                <table class="table table-sm table-striped sheet-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Base Attack Bonus</th>
                            <th>STR Bonus</th>
                            <th>DEX Bonus</th>
                            <th>Size Bonus</th>
                            <th>Misc</th>
                            <th>Temp</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Base Attack Bonus</td>
                            <td colspan="7">@Model?.BaseAttackBonus</td>
                        </tr>
                        <tr>
                            <td>Melee Attack</td>
                            <td>@Model?.MeleeAttackBonus.BaseAttackBonus</td>
                            <td>@Model?.MeleeAttackBonus.AbilityMod</td>
                            <td class="disabled-cell"></td>
                            <td>@Model?.MeleeAttackBonus.SizeBonus</td>
                            <td>@Model?.MeleeAttackBonus.Misc</td>
                            <td>@Model?.MeleeAttackBonus.Temp</td>
                            <td>@Model?.MeleeAttackBonus.Total</td>
                        </tr>
                        <tr>
                            <td>Ranged Attack</td>
                            <td>@Model?.RangedAttackBonus.BaseAttackBonus</td>
                            <td class="disabled-cell"></td>
                            <td>@Model?.RangedAttackBonus.AbilityMod</td>
                            <td>@Model?.RangedAttackBonus.SizeBonus</td>
                            <td>@Model?.RangedAttackBonus.Misc</td>
                            <td>@Model?.RangedAttackBonus.Temp</td>
                            <td>@Model?.RangedAttackBonus.Total</td>
                        </tr>
                        <tr>
                            <td>CMB</td>
                            <td>@Model?.CombatManeuverBonus.BaseAttackBonus</td>
                            <td class="disabled-cell"></td>
                            <td>@Model?.CombatManeuverBonus.AbilityMod</td>
                            <td>@Model?.CombatManeuverBonus.SizeBonus</td>
                            <td>@Model?.CombatManeuverBonus.Misc</td>
                            <td>@Model?.CombatManeuverBonus.Temp</td>
                            <td>@Model?.CombatManeuverBonus.Total</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        @if (Model != null && Model.SkillDetails.Any())
        {
            <div class="section card shadow-sm skills-section">
                <div class="card-header">Skills (@Model.SkillPointsSpent spent)</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th>Skill</th>
                                <th>Ability</th>
                                <th>Ability Bonus</th>
                                <th>Ranks</th>
                                <th>Misc</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var skill in Model.SkillDetails)
                            {
                                <tr>
                                    <td>@skill.Name</td>
                                    <td>@skill.Ability</td>
                                    <td>@skill.AbilityBonus</td>
                                    <td>@skill.Ranks</td>
                                    <td>@skill.Misc</td>
                                    <td>@skill.Total</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        @if (Model != null && Model.SpecialAbilities.Any())
        {
            <div class="section card shadow-sm">
                <div class="card-header">Special Abilities</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Source</th>
                                <th>Text</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ability in Model.SpecialAbilities)
                            {
                                <tr>
                                    <td>@ability.Name</td>
                                    <td>@ability.Source</td>
                                    <td>@Html.Raw(ability.Text)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        @if (Model != null && Model.FeatDetails.Any())
        {
            <div class="section card shadow-sm feats-section">
                <div class="card-header">Feats</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Summary</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.FeatDetails.Count; i++)
                            {
                                var feat = Model.FeatDetails[i];
                                var modalId = $"featModal{i}";
                                <tr data-bs-toggle="modal" data-bs-target="#@modalId" style="cursor:pointer">
                                    <td>@feat.Name</td>
                                    <td>@feat.Summary</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    @for (int i = 0; i < Model.FeatDetails.Count; i++)
                    {
                        var feat = Model.FeatDetails[i];
                        var modalId = $"featModal{i}";
                        <div class="modal fade" id="@modalId" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">@feat.Name</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <dl>
                                            <dt>Type</dt><dd>@feat.Type</dd>
                                            @if (!string.IsNullOrEmpty(feat.Prerequisites))
                                            {
                                                <dt>Prerequisites</dt><dd>@feat.Prerequisites</dd>
                                            }
                                            @if (!string.IsNullOrEmpty(feat.Benefit))
                                            {
                                                <dt>Benefit</dt><dd>@Html.Raw(feat.Benefit)</dd>
                                            }
                                            @if (!string.IsNullOrEmpty(feat.Normal))
                                            {
                                                <dt>Normal</dt><dd>@Html.Raw(feat.Normal)</dd>
                                            }
                                            @if (!string.IsNullOrEmpty(feat.Special))
                                            {
                                                <dt>Special</dt><dd>@Html.Raw(feat.Special)</dd>
                                            }
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        @if (Model != null && Model.Traits.Any())
        {
            <div class="section card shadow-sm">
                <div class="card-header">Traits</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Source</th>
                                <th>Text</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var trait in Model.Traits)
                            {
                                <tr>
                                    <td>@trait.Name</td>
                                    <td>@trait.Source</td>
                                    <td>@Html.Raw(trait.Text)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        @if (Model != null && Model.Proficiencies.Any())
        {
            <div class="section card shadow-sm">
                <div class="card-header">Proficiencies</div>
                <div class="card-body">
                    <p>@string.Join(", ", Model.Proficiencies)</p>
                </div>
            </div>
        }

        @if (Model != null && Model.EquipmentDetails.Any())
        {
            <div class="section card shadow-sm equipment-section">
                <div class="card-header">Equipment</div>
                <div class="card-body">
                    @foreach (var group in Model.EquipmentDetails.GroupBy(e => e.Type))
                    {
                        var items = group.ToList();
                        var safeType = group.Key.Replace(" ", "");
                        <h3>@group.Key</h3>
                        <table class="table table-sm table-striped sheet-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Subtype</th>
                                    <th>Cost</th>
                                    <th>Weight</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < items.Count; i++)
                                {
                                    var item = items[i];
                                    var modalId = $"equipModal_{safeType}_{i}";
                                    <tr data-bs-toggle="modal" data-bs-target="#@modalId" style="cursor:pointer">
                                        <td>@item.Name</td>
                                        <td>@item.Subtype</td>
                                        <td>@item.Cost</td>
                                        <td>@item.Weight</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        @for (int i = 0; i < items.Count; i++)
                        {
                            var item = items[i];
                            var modalId = $"equipModal_{safeType}_{i}";
                            <div class="modal fade" id="@modalId" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">@item.Name</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <dl>
                                                <dt>Type</dt><dd>@item.Type</dd>
                                                <dt>Subtype</dt><dd>@item.Subtype</dd>
                                                <dt>Cost</dt><dd>@item.Cost</dd>
                                                <dt>Weight</dt><dd>@item.Weight</dd>
                                                <dt>Description</dt><dd>@Html.Raw(item.Description)</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        }

        @if (Model != null && Model.Spells.Any())
        {
            <div class="section card shadow-sm">
                <div class="card-header">Spells</div>
                <div class="card-body">
                    <p>@string.Join(", ", Model.Spells)</p>
                </div>
            </div>
        }
    </div>
</div>

