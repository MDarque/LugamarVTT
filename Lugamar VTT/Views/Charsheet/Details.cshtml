@model LugamarVTT.Models.Character
@using System
@using System.Linq
@using System.Text.Json
@using LugamarVTT.Models

@{
    ViewData["Title"] = Model?.Name ?? "Character Details";
}

@section Styles {
    <link rel="stylesheet" href="~/css/charsheet.css" />
}


<h1 class="mt-4 mb-3">@Model?.Name</h1>
<a asp-action="Index" class="btn btn-secondary mb-3">&larr; Back to list</a>

<div class="charsheet">
    <!-- Row 1: Character Information -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Character Information</div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label">Name</label>
                            <input class="form-control" readonly value="@Model?.Name" />
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label">Gender</label>
                            <input class="form-control" readonly value="@Model?.Gender" />
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label">Age</label>
                            <input class="form-control" readonly value="@Model?.Age" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Height</label>
                            <input class="form-control" readonly value="@Model?.Height" />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label">Weight</label>
                            <input class="form-control" readonly value="@Model?.Weight" />
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label">Size</label>
                            <input class="form-control" readonly value="@Model?.Size" />
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label">Alignment</label>
                            <input class="form-control" readonly value="@Model?.Alignment" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Deity</label>
                            <input class="form-control" readonly value="@Model?.Deity" />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label class="form-label">Race</label>
                            <input class="form-control" readonly value="@Model?.Race" />
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label class="form-label">XP</label>
                            <input class="form-control" readonly value="@Model?.Experience" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">XP Needed</label>
                            <input class="form-control" readonly value="@Model?.ExperienceNeeded" />
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Class</th>
                                    <th>Level</th>
                                    <th>Favored</th>
                                    <th>Skill Ranks</th>
                                    <th>Skill Ranks Used</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var cls in Model?.Classes ?? Enumerable.Empty<CharacterClass>())
                                {
                                    <tr>
                                        <td>@cls.Name</td>
                                        <td>@cls.Level</td>
                                        <td class="text-center">
                                            <input class="form-check-input" type="checkbox" disabled @(cls.Favored ? "checked" : string.Empty) />
                                        </td>
                                        <td>@cls.SkillRanks</td>
                                        <td>@cls.SkillRanksUsed</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Ability Scores & Saving Throws; Hit Points, Initiative & Speed -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card shadow-sm mb-4">
                <div class="card-header">Ability Scores</div>
                <div class="card-body full-border">
@{
    var abilityList = new[]
    {
        new { Key = "strength", Abbr = "STR", Full = "Strength" },
        new { Key = "dexterity", Abbr = "DEX", Full = "Dexterity" },
        new { Key = "constitution", Abbr = "CON", Full = "Constitution" },
        new { Key = "intelligence", Abbr = "INT", Full = "Intelligence" },
        new { Key = "wisdom", Abbr = "WIS", Full = "Wisdom" },
        new { Key = "charisma", Abbr = "CHA", Full = "Charisma" }
    };
    var jsonOptions = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
}
                    <table class="table table-bordered ability-table mb-0">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Score</th>
                                <th>Mod</th>
                                <th>Base</th>
                                <th>Dmg</th>
                                <th>Perm</th>
                            </tr>
                        </thead>
                        <tbody>
@foreach (var ability in abilityList)
{
    LugamarVTT.Models.AbilityScore? data = null;
    if (Model != null && Model.Abilities.TryGetValue(ability.Key, out var found))
    {
        data = found;
    }
    data ??= new LugamarVTT.Models.AbilityScore();
                            <tr>
                                <th class="ability-name">
                                    <div class="abbr">@ability.Abbr</div>
                                    <div class="full">@ability.Full</div>
                                </th>
                                <td><input class="form-control text-center" readonly value="@data.Score" /></td>
                                <td><input class="form-control text-center" readonly value="@data.Bonus" /></td>
                                <td><input class="form-control text-center" readonly value="@data.Base" /></td>
                                <td><input class="form-control text-center" readonly value="@data.Damage" /></td>
                                <td>
                                    <input class="form-control text-center" readonly value="@data.Perm"
                                           data-bs-toggle="modal" data-bs-target="#permModal"
                                           data-perms='@Html.Raw(JsonSerializer.Serialize(data.Perms, jsonOptions))' />
                                </td>
                            </tr>
}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card shadow-sm">
                <div class="card-header">Saving Throws</div>
                <div class="card-body full-border">
                    <table class="table table-sm table-striped sheet-table mb-0 saving-throws-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Total</th>
                                <th>Class</th>
                                <th>Stat</th>
                                <th>Misc</th>
                                <th>Temp</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Fortitude</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.Fortitude.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Fortitude.Base" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Fortitude.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Fortitude.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Fortitude.Temp" /></td>
                            </tr>
                            <tr>
                                <td>Reflex</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.Reflex.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Reflex.Base" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Reflex.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Reflex.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Reflex.Temp" /></td>
                            </tr>
                            <tr>
                                <td>Will</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.Will.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Will.Base" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Will.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Will.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Will.Temp" /></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header">Hit Points</div>
                <div class="card-body">
                    <div class="row mb-3 full-border">
                        <div class="col">
                            <label class="form-label">Current</label>
                            <input class="form-control" readonly value="@Model?.CurrentHitPoints" />
                        </div>
                        <div class="col">
                            <label class="form-label">Total</label>
                            <input class="form-control" readonly value="@Model?.HitPoints" />
                        </div>
                        <div class="col">
                            <label class="form-label">Temp</label>
                            <input class="form-control" readonly value="@Model?.TempHitPoints" />
                        </div>
                        <div class="col">
                            <label class="form-label">Wounds</label>
                            <input class="form-control" readonly value="@Model?.Wounds" />
                        </div>
                        <div class="col">
                            <label class="form-label">Non-Lethal</label>
                            <input class="form-control" readonly value="@Model?.NonLethalDamage" />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label">Damage Reduction</label>
                            <input class="form-control" readonly value="@Model?.DamageReduction" />
                        </div>
                        <div class="col">
                            <label class="form-label">Spell Resistance</label>
                            <input class="form-control" readonly value="@Model?.SpellResistance" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Resistances</label>
                        <input class="form-control" readonly value="@Model?.Resistances" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Immunities</label>
                        <input class="form-control" readonly value="@Model?.Immunities" />
                    </div>
                    <div>
                        <label class="form-label">Other Special Qualities</label>
                        <input class="form-control" readonly value="@Model?.SpecialQualities" />
                    </div>
                </div>
            </div>
            <div class="card shadow-sm">
                <div class="card-header">Initiative &amp; Speed</div>
                <div class="card-body full-border">
                    <div class="mb-3">
                        <label class="form-label">Initiative</label>
                        <input class="form-control" readonly value="@Model?.Initiative" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Speed</label>
                        <input class="form-control" readonly value="@Model?.Speed" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3: Armor Class -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Armor Class</div>
                <div class="card-body full-border">
                    <table class="table table-sm table-striped sheet-table mb-4">
                        <thead>
                            <tr>
                                <th></th>
                                <th>DEX Modifier</th>
                                <th>Size Modifier</th>
                                <th>Armor Bonus</th>
                                <th>Shield Bonus</th>
                                <th>Natural Armor</th>
                                <th>Dodge</th>
                                <th>Misc</th>
                                <th>Deflection</th>
                                <th>Temp</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Armor Class</td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.DexModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.SizeModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.ArmorBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.ShieldBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.NaturalArmor" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Dodge" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Deflection" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Temp" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Total" /></td>
                            </tr>
                            <tr>
                                <td>Touch</td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.DexModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.SizeModifier" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.ArmorBonus" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.ShieldBonus" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.NaturalArmor" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Dodge" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Deflection" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Temp" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Total" /></td>
                            </tr>
                            <tr>
                                <td>Flat-Footed</td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.DexModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.SizeModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.ArmorBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.ShieldBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.NaturalArmor" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Dodge" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Deflection" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Temp" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Total" /></td>
                            </tr>
                        </tbody>
                    </table>
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Base Attack Bonus</th>
                                <th>STR Bonus</th>
                                <th>DEX Bonus</th>
                                <th>Size Bonus</th>
                                <th>Misc</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>CMD</td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.BaseAttackBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.StrBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.DexBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.SizeBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.Total" /></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 4: Attack Bonus -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Attack Bonus</div>
                <div class="card-body full-border">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Base Attack Bonus</th>
                                <th>STR Bonus</th>
                                <th>DEX Bonus</th>
                                <th>Size Bonus</th>
                                <th>Misc</th>
                                <th>Temp</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Base Attack Bonus</td>
                                <td colspan="7"><input class="form-control form-control-sm" readonly value="@Model?.BaseAttackBonus" /></td>
                            </tr>
                            <tr>
                                <td>Melee Attack</td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.BaseAttackBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.AbilityMod" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.SizeBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.Temp" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.Total" /></td>
                            </tr>
                            <tr>
                                <td>Ranged Attack</td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.BaseAttackBonus" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.SizeBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.Temp" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.Total" /></td>
                            </tr>
                            <tr>
                                <td>CMB</td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.BaseAttackBonus" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.SizeBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.Temp" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.Total" /></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 5: Skills -->
    @if (Model != null && Model.SkillDetails.Any()) {
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Skills (@Model.SkillPointsSpent spent)</div>
                <div class="card-body full-border">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th>Skill</th>
                                <th>Ability</th>
                                <th>Ability Bonus</th>
                                <th>Ranks</th>
                                <th>Misc</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var skill in Model.SkillDetails) {
                                <tr>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.Name" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.Ability" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.AbilityBonus" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.Ranks" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.Misc" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.Total" /></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Row 6: Feats; Special Abilities -->
    <div class="row mb-4">
        @if (Model != null && Model.FeatDetails.Any()) {
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card shadow-sm h-100">
                <div class="card-header">Feats</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Summary</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var feat in Model.FeatDetails) {
                                <tr>
                                    <td><input class="form-control form-control-sm" readonly value="@feat.Name" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@feat.Summary" /></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        }
        @if (Model != null && Model.SpecialAbilities.Any()) {
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">Special Abilities</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Source</th>
                                <th>Text</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ability in Model.SpecialAbilities) {
                                <tr>
                                    <td><input class="form-control form-control-sm" readonly value="@ability.Name" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@ability.Source" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@Html.Raw(ability.Text).ToString().Replace('\n',' ')" /></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        }
    </div>

    <!-- Row 7: Proficiencies; Traits -->
    <div class="row mb-4">
        @if (Model != null && Model.Proficiencies.Any()) {
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card shadow-sm h-100">
                <div class="card-header">Proficiencies</div>
                <div class="card-body">
                    <input class="form-control" readonly value="@string.Join(", ", Model.Proficiencies)" />
                </div>
            </div>
        </div>
        }
        @if (Model != null && Model.Traits.Any()) {
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">Traits</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Source</th>
                                <th>Text</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var trait in Model.Traits) {
                                <tr>
                                    <td><input class="form-control form-control-sm" readonly value="@trait.Name" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@trait.Source" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@Html.Raw(trait.Text).ToString().Replace('\n',' ')" /></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        }
    </div>

    <!-- Row 8: Equipment -->
    @if (Model != null && Model.EquipmentDetails.Any()) {
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Equipment</div>
                <div class="card-body">
                    @foreach (var group in Model.EquipmentDetails.GroupBy(e => e.Type)) {
                        <h3>@group.Key</h3>
                        <table class="table table-sm table-striped sheet-table mb-4">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Subtype</th>
                                    <th>Cost</th>
                                    <th>Weight</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in group) {
                                    <tr>
                                        <td><input class="form-control form-control-sm" readonly value="@item.Name" /></td>
                                        <td><input class="form-control form-control-sm" readonly value="@item.Subtype" /></td>
                                        <td><input class="form-control form-control-sm" readonly value="@item.Cost" /></td>
                                        <td><input class="form-control form-control-sm" readonly value="@item.Weight" /></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Row 9: Spells -->
    @if (Model != null && Model.Spells.Any()) {
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Spells</div>
                <div class="card-body">
                    <input class="form-control" readonly value="@string.Join(", ", Model.Spells)" />
                </div>
            </div>
        </div>
    </div>
    }
    <div class="modal fade" id="permModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Permanent Adjustments</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Perm</th>
                                <th>Type</th>
                                <th>Name</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const permModal = document.getElementById('permModal');
        permModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            const perms = JSON.parse(button.getAttribute('data-perms') || '[]');
            const body = permModal.querySelector('tbody');
            body.innerHTML = '';
            perms.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${p.permNum ?? ''}</td><td>${p.bonusType ?? ''}</td><td>${p.name ?? ''}</td>`;
                body.appendChild(row);
            });
        });
    </script>
}
