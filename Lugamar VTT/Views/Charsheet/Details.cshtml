@model LugamarVTT.Models.Character
@using System
@using System.Linq
@using System.Text.Json
@using LugamarVTT.Models
@using Microsoft.AspNetCore.Components

@{
    ViewData["Title"] = Model?.Name ?? "Character Details";
}

@section Styles {
    <link rel="stylesheet" href="~/css/charsheet.css" />
}


<h1 class="mt-4 mb-3">@Model?.Name</h1>
<a asp-action="Index" class="btn btn-secondary mb-3">&larr; Back to list</a>

<div class="charsheet">
    <!-- Row 1: Character Information -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Character Information</div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label">Name</label>
                            <input class="form-control" readonly value="@Model?.Name" />
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label">Gender</label>
                            <input class="form-control" readonly value="@Model?.Gender" />
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label">Age</label>
                            <input class="form-control" readonly value="@Model?.Age" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Height</label>
                            <input class="form-control" readonly value="@Model?.Height" />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label">Weight</label>
                            <input class="form-control" readonly value="@Model?.Weight" />
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label">Size</label>
                            <input class="form-control" readonly value="@Model?.Size" />
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label">Alignment</label>
                            <input class="form-control" readonly value="@Model?.Alignment" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Deity</label>
                            <input class="form-control" readonly value="@Model?.Deity" />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label class="form-label">Race</label>
                            <input class="form-control" readonly value="@Model?.Race" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="card shadow-sm mt-2">
                <div class="card-header">Class</div>
                <div class="card-body">
                    <div class="row mb-3 justify-content-center">
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label text-center">XP</label>
                            <input class="form-control full-border-lg" readonly value="@Model?.Experience" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-center">XP Needed</label>
                            <input class="form-control full-border-lg" readonly value="@Model?.ExperienceNeeded" />
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th><b>Class</b></th>
                                    <th><b>Level</b></th>
                                    <th class="text-center"><b>Favored</b></th>
                                    <th><b>Skill Ranks</b></th>
                                    <th><b>Skill Ranks Used</b></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var cls in Model?.Classes ?? Enumerable.Empty<CharacterClass>())
                                {
                                    <tr>
                                        <td>@cls.Name</td>
                                        <td>@cls.Level</td>
                                        <td class="text-center">
                                            <input class="form-check-input" type="checkbox" disabled @(cls.Favored ? "checked" : string.Empty) />
                                        </td>
                                        <td>@cls.SkillRanks</td>
                                        <td>@cls.SkillRanksUsed</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Ability Scores & Hit Points -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card shadow-sm">
                <div class="card-header">Ability Scores</div>
                <div class="card-body full-border">
@{
    var abilityList = new[]
    {
        new { Key = "strength", Abbr = "STR", Full = "Strength" },
        new { Key = "dexterity", Abbr = "DEX", Full = "Dexterity" },
        new { Key = "constitution", Abbr = "CON", Full = "Constitution" },
        new { Key = "intelligence", Abbr = "INT", Full = "Intelligence" },
        new { Key = "wisdom", Abbr = "WIS", Full = "Wisdom" },
        new { Key = "charisma", Abbr = "CHA", Full = "Charisma" }
    };
    var jsonOptions = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
}
                    <table class="table ability-table mb-0">
                        <thead>
                            <tr>
                                <th></th>
                                <th><b>Score</b></th>
                                <th><b>Mod</b></th>
                                <th><b>Base</b></th>
                                <th><b>Dmg</b></th>
                                <th><b>Perm</b></th>
                            </tr>
                        </thead>
                        <tbody>
@foreach (var ability in abilityList)
{
    LugamarVTT.Models.AbilityScore? data = null;
    if (Model != null && Model.Abilities.TryGetValue(ability.Key, out var found))
    {
        data = found;
    }
    data ??= new LugamarVTT.Models.AbilityScore();
                            <tr>
                                <th class="ability-name">
                                    <div class="abbr">@ability.Abbr</div>
                                    <div class="full">@ability.Full</div>
                                </th>
                                <td><input class="form-control text-center" readonly value="@data.Score" /></td>
                                <td><input class="form-control text-center" readonly value="@data.Bonus" /></td>
                                <td><input class="form-control text-center" readonly value="@data.Base" /></td>
                                <td><input class="form-control text-center" readonly value="@data.Damage" /></td>
                                <td>
                                    <input class="form-control text-center" readonly value="@data.Perm"
                                           data-bs-toggle="modal" data-bs-target="#permModal"
                                           data-perms='@Html.Raw(JsonSerializer.Serialize(data.Perms, jsonOptions))' />
                                </td>
                            </tr>
}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">Hit Points</div>
                <div class="card-body">
                    <div class="row mb-3 full-border">
                        <div class="col">
                            <label class="form-label">Current</label>
                            <input class="form-control" readonly value="@Model?.CurrentHitPoints" />
                        </div>
                        <div class="col">
                            <label class="form-label">Total</label>
                            <input class="form-control total" readonly value="@Model?.HitPoints" />
                        </div>
                        <div class="col">
                            <label class="form-label">Temp</label>
                            <input class="form-control" readonly value="@Model?.TempHitPoints" />
                        </div>
                        <div class="col">
                            <label class="form-label">Wounds</label>
                            <input class="form-control" readonly value="@Model?.Wounds" />
                        </div>
                        <div class="col">
                            <label class="form-label">Non-Lethal</label>
                            <input class="form-control" readonly value="@Model?.NonLethalDamage" />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label">Damage Reduction</label>
                            <input class="form-control" readonly value="@Model?.DamageReduction" />
                        </div>
                        <div class="col">
                            <label class="form-label">Spell Resistance</label>
                            <input class="form-control" readonly value="@Model?.SpellResistance" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Resistances</label>
                        <input class="form-control" readonly value="@Model?.Resistances" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Immunities</label>
                        <input class="form-control" readonly value="@Model?.Immunities" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Other Special Qualities</label>
                        <input class="form-control" readonly value="@Model?.SpecialQualities" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3: Saving Throws & Initiative & Speed -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card shadow-sm">
                <div class="card-header">Saving Throws</div>
                <div class="card-body full-border">
                    <table class="table table-sm table-striped sheet-table mb-0 saving-throws-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th><b>Total</b></th>
                                <th><b>Class</b></th>
                                <th><b>Stat</b></th>
                                <th><b>Misc</b></th>
                                <th><b>Temp</b></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Fortitude</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.Fortitude.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Fortitude.Base" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Fortitude.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Fortitude.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Fortitude.Temp" /></td>
                            </tr>
                            <tr>
                                <td>Reflex</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.Reflex.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Reflex.Base" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Reflex.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Reflex.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Reflex.Temp" /></td>
                            </tr>
                            <tr>
                                <td>Will</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.Will.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Will.Base" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Will.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Will.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Will.Temp" /></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">Initiative &amp; Speed</div>
                <div class="card-body full-border">
                    <table class="table table-sm table-striped sheet-table mb-3 saving-throws-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th><b>Total</b></th>
                                <th><b>Stat</b></th>
                                <th><b>Misc</b></th>
                                <th><b>Temp</b></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Initiative</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.Initiative.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Initiative.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Initiative.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Initiative.Temp" /></td>
                            </tr>
                        </tbody>
                    </table>
                    <table class="table table-sm table-striped sheet-table mb-0 saving-throws-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th><b>Total</b></th>
                                <th><b>Base</b></th>
                                <th><b>Armor</b></th>
                                <th><b>Misc</b></th>
                                <th><b>Temp</b></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Speed</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.Speed.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Speed.Base" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Speed.Armor" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Speed.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.Speed.Temp" /></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 4: Armor Class -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Armor Class</div>
                <div class="card-body full-border">
                    <table class="table table-sm table-striped sheet-table mb-4">
                        <thead>
                            <tr>
                                <th></th>
                                <th><b>Total</b></th>
                                <th><b>DEX Modifier</b></th>
                                <th><b>Size Modifier</b></th>
                                <th><b>Armor Bonus</b></th>
                                <th><b>Shield Bonus</b></th>
                                <th><b>Natural Armor</b></th>
                                <th><b>Dodge</b></th>
                                <th><b>Misc</b></th>
                                <th><b>Deflection</b></th>
                                <th><b>Temp</b></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Armor Class</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.DexModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.SizeModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.ArmorBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.ShieldBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.NaturalArmor" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Dodge" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Deflection" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Temp" /></td>
                            </tr>
                            <tr>
                                <td>Touch</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.DexModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.SizeModifier" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.ArmorBonus" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.ShieldBonus" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.NaturalArmor" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Dodge" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Deflection" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Temp" /></td>
                            </tr>
                            <tr>
                                <td>Flat-Footed</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Total" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.DexModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.SizeModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.ArmorBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.ShieldBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.NaturalArmor" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Dodge" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Deflection" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Temp" /></td>
                            </tr>
                        </tbody>
                    </table>
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th><b>Total</b></th>
                                <th><b>Base Attack Bonus</b></th>
                                <th><b>STR Bonus</b></th>
                                <th><b>DEX Bonus</b></th>
                                <th><b>Size Bonus</b></th>
                                <th><b>Misc</b></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>CMD</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.BaseAttackBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.StrBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.DexBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.SizeBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.Misc" /></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 5: Attack Bonus -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Attack Bonus</div>
                <div class="card-body full-border">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th><b>Total</b></th>
                                <th><b>Base Attack Bonus</b></th>
                                <th><b>STR Bonus</b></th>
                                <th><b>DEX Bonus</b></th>
                                <th><b>Size Bonus</b></th>
                                <th><b>Misc</b></th>
                                <th><b>Temp</b></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Base Attack Bonus</td>
                                <td colspan="7" class="total"><input class="form-control form-control-sm" readonly value="@Model?.BaseAttackBonus" /></td>
                            </tr>
                            <tr>
                                <td>Melee Attack</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.BaseAttackBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm disabled-cell" readonly /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.SizeBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.Temp" /></td>
                            </tr>
                            <tr>
                                <td>Ranged Attack</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.BaseAttackBonus" /></td>
                                <td><input class="form-control form-control-sm disabled-cell" readonly /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.SizeBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.Temp" /></td>
                            </tr>
                            <tr>
                                <td>CMB</td>
                                <td class="total"><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.Total" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.BaseAttackBonus" /></td>
                                <td><input class="form-control form-control-sm disabled-cell" readonly /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.SizeBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.Temp" /></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 6: Skills -->
    @if (Model != null && Model.SkillDetails.Any()) {
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Skills (@Model.SkillPointsSpent spent)</div>
                <div class="card-body full-border">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th><b>Skill</b></th>
                                <th><b>Ability</b></th>
                                <th><b>Ranks</b></th>
                                <th><b>Ability <br />Bonus</b></th>
                                <th><b>Misc</b></th>
                                <th><b>Total</b></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var skill in Model.SkillDetails) {
                                <tr>
                                    <td><label class="form-label">@skill.Name</label></td>
                                    <td><label class="form-label">@skill.Ability</label></td>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.Ranks" /></td>
                                    <td class="text-center"><input class="form-control form-control-sm" readonly value="@skill.AbilityBonus" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.Misc" /></td>
                                    <td class="total"><input class="form-control form-control-sm" readonly value="@skill.Total" /></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Row 7: Feats; Special Abilities -->
    <div class="row mb-4">
        @if (Model != null && Model.FeatDetails.Any()) {
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card shadow-sm h-100">
                <div class="card-header">Feats</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th><b>Name</b></th>
                                <th><b>Summary</b></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var feat in Model.FeatDetails) {
                                <tr style="cursor:pointer"
                                    data-bs-toggle="modal" data-bs-target="#featModal"
                                    data-name="@feat.Name"
                                    data-type="@feat.Type"
                                    data-prerequisites="@feat.Prerequisites"
                                    data-benefit='@feat.Benefit'
                                    data-normal='@feat.Normal'
                                    data-special='@feat.Special'>
                                    <td><span readonly>@feat.Name</span></td>
                                    <td><span readonly>@feat.Summary</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        }
        @if (Model != null && Model.SpecialAbilities.Any()) {
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">Special Abilities</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th><b>Name</b></th>
                                <th><b>Summary</b></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ability in Model.SpecialAbilities) {
                                <tr style="cursor:pointer"
                                    data-bs-toggle="modal" data-bs-target="#abilityModal"
                                    data-name="@ability.Name"
                                    data-type="@ability.Type"
                                    data-level="@ability.Level"
                                    data-source="@ability.Source"
                                    data-text='@(ability.Text.Value ?? "")'>
                                    <td><span readonly>@ability.Name</span></td>
                                    <td><span readonly>@ability.Summary</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        }
    </div>

    <!-- Row 8: Proficiencies; Traits -->
    <div class="row mb-4">
        @if (Model != null && Model.Proficiencies.Any()) {
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card shadow-sm h-100">
                <div class="card-header">Proficiencies</div>
                <div class="card-body">
                    @foreach (var proficiency in Model.Proficiencies) {
                        <p>@proficiency</p>
                    }
                </div>
            </div>
        </div>
        }
        @if (Model != null && Model.Traits.Any()) {
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">Traits</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th><b>Name</b></th>
                                <th><b>Summary</b></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var trait in Model.Traits) {
                                <tr style="cursor:pointer"
                                    data-bs-toggle="modal" data-bs-target="#traitModal"
                                    data-name="@trait.Name"
                                    data-source="@trait.Source"
                                    data-text='@(trait.Text.Value ?? "")'>
                                    <td><span readonly>@trait.Name</span></td>
                                    <td><span readonly>@trait.Summary</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        }
    </div>

    <!-- Row 9: Equipment -->
    @if (Model != null && Model.EquipmentDetails.Any()) {
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Equipment</div>
                <div class="card-body">
                    @foreach (var group in Model.EquipmentDetails.GroupBy(e => e.Type)) {
                        <h3>@group.Key</h3>
                        <table class="table table-sm table-striped sheet-table mb-4">
                            <thead>
                                <tr>
                                    <th><b>Name</b></th>
                                    <th><b>Subtype</b></th>
                                    <th><b>Cost</b></th>
                                    <th><b>Weight</b></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in group) {
                                    <tr>
                                        <td><span>@item.Name</span></td>
                                        <td><span>@item.Subtype</span></td>
                                        <td><span>@item.Cost</span></td>
                                        <td><span>@item.Weight</span></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Row 10: Spells -->
    @if (Model != null && Model.Spells.Any()) {
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Spells</div>
                <div class="card-body">
                    <input class="form-control" readonly value="@string.Join(", ", Model.Spells)" />
                </div>
            </div>
        </div>
    </div>
    }
    <div class="modal fade" id="featModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="featModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Type:</strong> <span id="featModalType"></span></p>
                    <p><strong>Prerequisites:</strong> <span id="featModalPrereqs"></span></p>
                    <div>
                        <p><strong>Benefit:</strong></p>
                        <div id="featModalBenefit"></div>
                    </div>
                    <div>
                        <p><strong>Normal:</strong></p>
                        <div id="featModalNormal"></div>
                    </div>
                    <div>
                        <p><strong>Special:</strong></p>
                        <div id="featModalSpecial"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="abilityModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="abilityModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Type:</strong> <span id="abilityModalType"></span></p>
                    <p><strong>Level:</strong> <span id="abilityModalLevel"></span></p>
                    <p><strong>Source:</strong> <span id="abilityModalSource"></span></p>
                    <div id="abilityModalText"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="traitModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="traitModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Source:</strong> <span id="traitModalSource"></span></p>
                    <div id="traitModalText"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="permModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Permanent Adjustments</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th><b>Perm</b></th>
                                <th><b>Type</b></th>
                                <th><b>Name</b></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const permModal = document.getElementById('permModal');
        permModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            const perms = JSON.parse(button.getAttribute('data-perms') || '[]');
            const body = permModal.querySelector('tbody');
            body.innerHTML = '';
            perms.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${p.permNum ?? ''}</td><td>${p.bonusType ?? ''}</td><td>${p.name ?? ''}</td>`;
                body.appendChild(row);
            });
        });

        const featModal = document.getElementById('featModal');
        featModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            featModal.querySelector('#featModalTitle').textContent = button.getAttribute('data-name') || '';
            featModal.querySelector('#featModalType').textContent = button.getAttribute('data-type') || '';
            featModal.querySelector('#featModalPrereqs').textContent = button.getAttribute('data-prerequisites') || '';
            featModal.querySelector('#featModalBenefit').innerHTML = button.getAttribute('data-benefit') || '';
            featModal.querySelector('#featModalNormal').innerHTML = button.getAttribute('data-normal') || '';
            featModal.querySelector('#featModalSpecial').innerHTML = button.getAttribute('data-special') || '';
        });

        const traitModal = document.getElementById('traitModal');
        traitModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            traitModal.querySelector('#traitModalTitle').textContent = button.getAttribute('data-name') || '';
            traitModal.querySelector('#traitModalSource').textContent = button.getAttribute('data-source') || '';
            traitModal.querySelector('#traitModalText').innerHTML = button.getAttribute('data-text') || '';
        });

        const abilityModal = document.getElementById('abilityModal');
        abilityModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            abilityModal.querySelector('#abilityModalTitle').textContent = button.getAttribute('data-name') || '';
            abilityModal.querySelector('#abilityModalType').textContent = button.getAttribute('data-type') || '';
            abilityModal.querySelector('#abilityModalLevel').textContent = button.getAttribute('data-level') || '';
            abilityModal.querySelector('#abilityModalSource').textContent = button.getAttribute('data-source') || '';
            abilityModal.querySelector('#abilityModalText').innerHTML = button.getAttribute('data-text') || '';
        });
    </script>
}
