@model LugamarVTT.Models.Character
@using System
@using System.Linq

@{
    ViewData["Title"] = Model?.Name ?? "Character Details";
}

@section Styles {
    <link rel="stylesheet" href="~/css/charsheet.css" />
}

@functions {
    int Mod(int score) => (int)Math.Floor((score - 10) / 2.0);
}

<h1 class="mt-4 mb-3">@Model?.Name</h1>
<a asp-action="Index" class="btn btn-secondary mb-3">&larr; Back to list</a>

<div class="charsheet">
    <!-- Row 1: Character Information -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Character Information</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Race</label>
                        <input class="form-control" readonly value="@Model?.Race" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Class</label>
                        <input class="form-control" readonly value="@Model?.Class" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Alignment</label>
                        <input class="form-control" readonly value="@Model?.Alignment" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Level</label>
                        <input class="form-control" readonly value="@Model?.Level" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Ability Scores; Hit Points, Initiative & Speed -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card h-100 shadow-sm">
                <div class="card-header">Ability Scores</div>
                <div class="card-body">
                    <div class="ability-scores">
                        <div class="ability">
                            <label>STR</label>
                            <input class="form-control mb-1 text-center" readonly value="@Model?.Strength" />
                            <input class="form-control text-center" readonly value="@Mod(Model?.Strength ?? 0)" />
                        </div>
                        <div class="ability">
                            <label>DEX</label>
                            <input class="form-control mb-1 text-center" readonly value="@Model?.Dexterity" />
                            <input class="form-control text-center" readonly value="@Mod(Model?.Dexterity ?? 0)" />
                        </div>
                        <div class="ability">
                            <label>CON</label>
                            <input class="form-control mb-1 text-center" readonly value="@Model?.Constitution" />
                            <input class="form-control text-center" readonly value="@Mod(Model?.Constitution ?? 0)" />
                        </div>
                        <div class="ability">
                            <label>INT</label>
                            <input class="form-control mb-1 text-center" readonly value="@Model?.Intelligence" />
                            <input class="form-control text-center" readonly value="@Mod(Model?.Intelligence ?? 0)" />
                        </div>
                        <div class="ability">
                            <label>WIS</label>
                            <input class="form-control mb-1 text-center" readonly value="@Model?.Wisdom" />
                            <input class="form-control text-center" readonly value="@Mod(Model?.Wisdom ?? 0)" />
                        </div>
                        <div class="ability">
                            <label>CHA</label>
                            <input class="form-control mb-1 text-center" readonly value="@Model?.Charisma" />
                            <input class="form-control text-center" readonly value="@Mod(Model?.Charisma ?? 0)" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header">Hit Points</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Current</label>
                        <input class="form-control" readonly value="@Model?.CurrentHitPoints" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Total</label>
                        <input class="form-control" readonly value="@Model?.HitPoints" />
                    </div>
                </div>
            </div>
            <div class="card shadow-sm">
                <div class="card-header">Initiative &amp; Speed</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Initiative</label>
                        <input class="form-control" readonly value="@Model?.Initiative" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Speed</label>
                        <input class="form-control" readonly value="@Model?.Speed" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3: Armor Class -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Armor Class</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table mb-4">
                        <thead>
                            <tr>
                                <th></th>
                                <th>DEX Modifier</th>
                                <th>Size Modifier</th>
                                <th>Armor Bonus</th>
                                <th>Shield Bonus</th>
                                <th>Natural Armor</th>
                                <th>Dodge</th>
                                <th>Misc</th>
                                <th>Deflection</th>
                                <th>Temp</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Armor Class</td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.DexModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.SizeModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.ArmorBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.ShieldBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.NaturalArmor" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Dodge" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Deflection" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Temp" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.ArmorClassBreakdown.Total" /></td>
                            </tr>
                            <tr>
                                <td>Touch</td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.DexModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.SizeModifier" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.ArmorBonus" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.ShieldBonus" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.NaturalArmor" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Dodge" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Deflection" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Temp" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.TouchArmorClassBreakdown.Total" /></td>
                            </tr>
                            <tr>
                                <td>Flat-Footed</td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.DexModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.SizeModifier" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.ArmorBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.ShieldBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.NaturalArmor" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Dodge" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Deflection" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Temp" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.FlatFootedArmorClassBreakdown.Total" /></td>
                            </tr>
                        </tbody>
                    </table>
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Base Attack Bonus</th>
                                <th>STR Bonus</th>
                                <th>DEX Bonus</th>
                                <th>Size Bonus</th>
                                <th>Misc</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>CMD</td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.BaseAttackBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.StrBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.DexBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.SizeBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverDefense.Total" /></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 4: Saving Throws -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Saving Throws</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Fortitude</label>
                        <input class="form-control" readonly value="@Model?.Fortitude" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reflex</label>
                        <input class="form-control" readonly value="@Model?.Reflex" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Will</label>
                        <input class="form-control" readonly value="@Model?.Will" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 5: Attack Bonus -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Attack Bonus</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Base Attack Bonus</th>
                                <th>STR Bonus</th>
                                <th>DEX Bonus</th>
                                <th>Size Bonus</th>
                                <th>Misc</th>
                                <th>Temp</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Base Attack Bonus</td>
                                <td colspan="7"><input class="form-control form-control-sm" readonly value="@Model?.BaseAttackBonus" /></td>
                            </tr>
                            <tr>
                                <td>Melee Attack</td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.BaseAttackBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.AbilityMod" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.SizeBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.Temp" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.MeleeAttackBonus.Total" /></td>
                            </tr>
                            <tr>
                                <td>Ranged Attack</td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.BaseAttackBonus" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.SizeBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.Temp" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.RangedAttackBonus.Total" /></td>
                            </tr>
                            <tr>
                                <td>CMB</td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.BaseAttackBonus" /></td>
                                <td class="disabled-cell"><input class="form-control form-control-sm" readonly /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.AbilityMod" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.SizeBonus" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.Misc" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.Temp" /></td>
                                <td><input class="form-control form-control-sm" readonly value="@Model?.CombatManeuverBonus.Total" /></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 6: Skills -->
    @if (Model != null && Model.SkillDetails.Any()) {
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Skills (@Model.SkillPointsSpent spent)</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th>Skill</th>
                                <th>Ability</th>
                                <th>Ability Bonus</th>
                                <th>Ranks</th>
                                <th>Misc</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var skill in Model.SkillDetails) {
                                <tr>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.Name" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.Ability" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.AbilityBonus" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.Ranks" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.Misc" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@skill.Total" /></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Row 7: Feats; Special Abilities -->
    <div class="row mb-4">
        @if (Model != null && Model.FeatDetails.Any()) {
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card shadow-sm h-100">
                <div class="card-header">Feats</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Summary</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var feat in Model.FeatDetails) {
                                <tr>
                                    <td><input class="form-control form-control-sm" readonly value="@feat.Name" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@feat.Summary" /></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        }
        @if (Model != null && Model.SpecialAbilities.Any()) {
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">Special Abilities</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Source</th>
                                <th>Text</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ability in Model.SpecialAbilities) {
                                <tr>
                                    <td><input class="form-control form-control-sm" readonly value="@ability.Name" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@ability.Source" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@Html.Raw(ability.Text).ToString().Replace('\n',' ')" /></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        }
    </div>

    <!-- Row 8: Proficiencies; Traits -->
    <div class="row mb-4">
        @if (Model != null && Model.Proficiencies.Any()) {
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card shadow-sm h-100">
                <div class="card-header">Proficiencies</div>
                <div class="card-body">
                    <input class="form-control" readonly value="@string.Join(", ", Model.Proficiencies)" />
                </div>
            </div>
        </div>
        }
        @if (Model != null && Model.Traits.Any()) {
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">Traits</div>
                <div class="card-body">
                    <table class="table table-sm table-striped sheet-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Source</th>
                                <th>Text</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var trait in Model.Traits) {
                                <tr>
                                    <td><input class="form-control form-control-sm" readonly value="@trait.Name" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@trait.Source" /></td>
                                    <td><input class="form-control form-control-sm" readonly value="@Html.Raw(trait.Text).ToString().Replace('\n',' ')" /></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        }
    </div>

    <!-- Row 9: Equipment -->
    @if (Model != null && Model.EquipmentDetails.Any()) {
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Equipment</div>
                <div class="card-body">
                    @foreach (var group in Model.EquipmentDetails.GroupBy(e => e.Type)) {
                        <h3>@group.Key</h3>
                        <table class="table table-sm table-striped sheet-table mb-4">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Subtype</th>
                                    <th>Cost</th>
                                    <th>Weight</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in group) {
                                    <tr>
                                        <td><input class="form-control form-control-sm" readonly value="@item.Name" /></td>
                                        <td><input class="form-control form-control-sm" readonly value="@item.Subtype" /></td>
                                        <td><input class="form-control form-control-sm" readonly value="@item.Cost" /></td>
                                        <td><input class="form-control form-control-sm" readonly value="@item.Weight" /></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Row 10: Spells -->
    @if (Model != null && Model.Spells.Any()) {
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header">Spells</div>
                <div class="card-body">
                    <input class="form-control" readonly value="@string.Join(", ", Model.Spells)" />
                </div>
            </div>
        </div>
    </div>
    }
</div>
